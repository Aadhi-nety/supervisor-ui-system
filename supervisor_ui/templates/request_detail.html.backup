<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Request #{{ request.id[:8] }} – AI Supervisor</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --primary:#6366f1;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --bg-light:#f5f7fa;
      --bg-dark:#0f172a;
      --card-light:#ffffff;
      --card-dark:#1e293b;
      --text-light:#1e293b;
      --text-dark:#e2e8f0;
      --radius:1.5rem;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --transition:.3s ease;
    }
    @media (prefers-color-scheme:dark){
      body{background:var(--bg-dark)!important;color:var(--text-dark)!important;}
      .card{background:var(--card-dark)!important;color:var(--text-dark)!important;}
      .form-control{background:var(--card-dark)!important;color:var(--text-dark)!important;border-color:#334155;}
      .form-control:focus{border-color:var(--primary);box-shadow:0 0 0 .2rem rgba(99,102,241,.25);}
    }
    body{background:var(--bg-light);font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;}
    .navbar{
      background:linear-gradient(135deg,var(--primary),#8b5cf6);
      box-shadow:var(--shadow);
    }
    .navbar-brand{font-weight:600;font-size:1.2rem;}

    /* chat bubbles */
    .bubble{
      background:var(--card-light);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:1.25rem 1.5rem;
      margin-bottom:1rem;
      max-width:80%;
      animation:fadeIn .5s ease forwards;
      opacity:0;
    }
    @keyframes fadeIn{to{opacity:1;}}
    .customer{border-left:6px solid var(--warning);}
    .supervisor{border-left:6px solid var(--success);}
    @media (prefers-color-scheme:dark){
      .bubble{background:var(--card-dark);}
    }

    /* editor */
    #editor{
      min-height:120px;
      border-radius:var(--radius);
      resize:none;
      transition:height var(--transition);
    }
    .toolbar button{
      background:transparent;border:1px solid #d1d5db;color:#6b7280;
      border-radius:.5rem;padding:.35rem .65rem;margin-right:.25rem;
      transition:background var(--transition),color var(--transition);
    }
    .toolbar button:hover{background:var(--primary);color:#fff;border-color:var(--primary);}
    #preview{min-height:120px;background:#f3f4f6;border-radius:var(--radius);padding:1rem;font-size:.95rem;}
    @media (prefers-color-scheme:dark){#preview{background:#1e293b;}}

    /* gradient buttons */
    .btn-gradient{
      background:linear-gradient(135deg,var(--primary),#8b5cf6);
      border:none;color:#fff;border-radius:2rem;padding:.55rem 1.4rem;font-weight:500;
      transition:box-shadow var(--transition);
    }
    .btn-gradient:hover{box-shadow:0 4px 14px rgba(99,102,241,.35);color:#fff;}
    
    /* Additional fixes */
    .markdown-preview img { max-width: 100%; }
    .form-label { margin-bottom: 0.5rem; }
    .form-text { margin-top: 0.25rem; }
    .alert { border-radius: var(--radius); }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/"><i class="fa-solid fa-robot me-2"></i>AI Supervisor</a>
    <a href="/" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-arrow-left-long me-1"></i>Dashboard</a>
  </div>
</nav>

<!-- Main Content -->
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">Help Request #{{ request.id[:8] }}</h3>
        {% if request.status == 'pending' %}
        <span class="badge bg-warning fs-6">Pending</span>
        {% else %}
        <span class="badge bg-success fs-6">Resolved</span>
        {% endif %}
      </div>

      <!-- Conversation -->
      <div class="bubble customer">
        <h6 class="fw-semibold mb-1">Customer <span class="text-muted fw-normal">({{ request.customer_phone }})</span></h6>
        <p class="mb-0">{{ request.question }}</p>
        <small class="text-muted">{{ request.created_at.strftime('%d %b %Y, %H:%M') }}</small>
      </div>

      {% if request.supervisor_answer %}
      <div class="bubble supervisor">
        <h6 class="fw-semibold mb-1">Supervisor</h6>
        <div class="markdown-preview">{{ request.supervisor_answer | safe }}</div>
        <small class="text-muted">{{ request.resolved_at.strftime('%d %b %Y, %H:%M') }}</small>
      </div>
      {% endif %}

      <!-- Response section (only if pending) -->
      {% if request.status == 'pending' %}
      <form method="POST" action="/request/{{ request.id }}/respond" class="mt-5">
        <label for="editor" class="form-label fw-bold mb-2">Your answer <small class="text-muted">(Markdown supported)</small></label>

        <!-- Toolbar -->
        <div class="toolbar mb-2">
          <button type="button" onclick="wrapText('**','**')"><i class="fa-solid fa-bold"></i></button>
          <button type="button" onclick="wrapText('*','*')"><i class="fa-solid fa-italic"></i></button>
          <button type="button" onclick="wrapText('\n- ','')"><i class="fa-solid fa-list-ul"></i></button>
          <button type="button" onclick="wrapText('[','](url)')"><i class="fa-solid fa-link"></i></button>
        </div>

        <!-- Editor + live preview -->
        <div class="row g-3">
          <div class="col-md-6">
            <textarea class="form-control" id="editor" name="answer" rows="6" required placeholder="Type here… (auto-growing)" oninput="autoGrow(this);livePreview()"></textarea>
            <div class="form-text"><span id="charCount">0</span> characters</div>
          </div>
          <div class="col-md-6">
            <div id="preview" class="border">Live preview will appear here…</div>
          </div>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn-gradient"><i class="fa-solid fa-paper-plane me-2"></i>Send & Resolve</button>
          <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
        </div>
      </form>
      {% else %}
      <div class="alert alert-success mt-4" role="alert">
        <i class="fa-solid fa-circle-check me-2"></i>Resolved on {{ request.resolved_at.strftime('%d %b %Y at %H:%M') }}.
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Editor helpers -->
<script>
  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const charCount = document.getElementById('charCount');

  function autoGrow(el) {
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }
  
  function livePreview() {
    charCount.textContent = editor.value.length;
    
    // Simple markdown parser for preview (fallback)
    let html = editor.value
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/\n- (.*?)(?=\n|$)/g, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
      .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
      .replace(/\n/g, '<br>');
    
    preview.innerHTML = html || 'Live preview will appear here…';
  }
  
  function wrapText(before, after) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selected = editor.value.substring(start, end);
    
    editor.setRangeText(before + selected + after, start, end, 'select');
    autoGrow(editor);
    livePreview();
    editor.focus();
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    livePreview();
  });
</script>
</body>
</html>